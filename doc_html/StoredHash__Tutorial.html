<html><head><title>StoredHash::Tutorial</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="http://search.cpan.org/s/style.css">

</head>
<body class='pod'>
<!--
  generated by Pod::Simple::HTML v3.16,
  using Pod::Simple::PullParser v3.16,
  under Perl v5.014002 at Sat Dec 20 17:33:48 2014 GMT.

 If you want to change this HTML document, you probably shouldn't do that
   by changing it directly.  Instead, see about changing the calling options
   to Pod::Simple::HTML, and/or subclassing Pod::Simple::HTML,
   then reconverting this document from the Pod source.
   When in doubt, email the author of Pod::Simple::HTML for advice.
   See 'perldoc Pod::Simple::HTML' for more info.

-->

<!-- start doc -->
<a name='___top' class='dummyTopAnchor' ></a>

<div class='indexgroup'>
<ul   class='indexList indexList1'>
  <li class='indexItem indexItem1'><a href='#NAME'>NAME</a>
  <li class='indexItem indexItem1'><a href='#Using_Autonumbered_primary_keys_with_StoredHash'>Using Autonumbered primary keys with StoredHash</a>
  <li class='indexItem indexItem1'><a href='#How_do_I_use_the_StoredHash_in_a_CGI_%2F_mod_perl_application_%3F'>How do I use the StoredHash in a CGI / mod_perl application ?</a>
  <li class='indexItem indexItem1'><a href='#I%27m_sending_an_AJAX_JSON_Message_From_Browser%2C_is_there_any_way_store_that_in_stored_hash_%3F'>I&#39;m sending an AJAX JSON Message From Browser, is there any way store that in stored hash ?</a>
  <li class='indexItem indexItem1'><a href='#Ways_to_use_StoredHash_in_data-pump_%2F_replication'>Ways to use StoredHash in data-pump / replication</a>
  <li class='indexItem indexItem1'><a href='#StoredHash_in_a_Perl%2FGTKBuilder_App'>StoredHash in a Perl/GTKBuilder App</a>
  <li class='indexItem indexItem1'><a href='#SEE_ALSO'>SEE ALSO</a>
</ul>
</div>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="NAME"
>NAME</a></h1>

<p>StoredHash::Tutorial - Practical use-case scenarios for StoredHash</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Using_Autonumbered_primary_keys_with_StoredHash"
>Using Autonumbered primary keys with StoredHash</a></h1>

<p>Using automatic DB backed assigned numbering for primary keys is a common practice.
When using this convention use StoredHash construction parameter &#39;autoid&#39; set to true value:</p>

<pre>    my $shp = StoredHash-&#62;new(.... , &#39;autoid&#39; =&#62; 1);</pre>

<p>At the DB backend these columns are typically defined:</p>

<dl>
<dt><a name="MySQL:_id_int_NOT_NULL_AUTO_INCREMENT"
>MySQL: id int NOT NULL AUTO_INCREMENT</a></dt>

<dd>
<dt><a name="SQLite:_id_INTEGER_PRIMARY_KEY_(Must_set_&#39;integer&#39;_not_only_&#39;int&#39;)"
>SQLite: id INTEGER PRIMARY KEY (Must set &#39;integer&#39; not only &#39;int&#39;)</a></dt>

<dd>
<dt><a name="MSSQL:_id_int_IDENTITY(1,1)_NOT_NULL_(Start_at_1,_inc._1)"
>MSSQL: id int IDENTITY(1,1) NOT NULL (Start at 1, inc. 1)</a></dt>

<dd>
<dt><a name="Postgres:_id_SERIAL_(NO_Type_!)"
>Postgres: id SERIAL (NO Type !)</a></dt>
</dl>

<p>Refer to the latest manuals of respective databases for most recent and accurate information.</p>

<p>StoredHash::ARS does not require primary key (&#39;pkey&#39;) or (&#39;autoid&#39;) as these are pre-determined by ARS/Remedy conventions.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="How_do_I_use_the_StoredHash_in_a_CGI_/_mod_perl_application_?"
>How do I use the StoredHash in a CGI / mod_perl application ?</a></h1>

<p>A simple example of a HTML form processing, assuming the db attribute names were used 1:1 on the HTML form:</p>

<pre>    sub handle_store {
        my ($cgi) = @_;
        my $h = $cgi-&#62;Vars();
        delete($h-&#62;{&#39;extrakey&#39;}); # Or any other keys that do not belong to DB
        my $id = $shp-&#62;insert($h);
        print(&#34;&#60;p&#62;Your entry was stored successfully (By ID: $id)\n&#60;/p&#62;&#34;);
        my $hfromdb = $shp-&#62;load([$id]);
        
        return(0);
    }</pre>

<p>Note: multiple values on a single key are encoded to null-byte delimited serial form by CGI.pm, above example assumes single value per key. On multi-valued keys you&#39;d likely hit problems.</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="I&#39;m_sending_an_AJAX_JSON_Message_From_Browser,_is_there_any_way_store_that_in_stored_hash_?"
>I&#39;m sending an AJAX JSON Message From Browser, is there any way store that in stored hash ?</a></h1>

<p>Lets use CGI.pm module for its ubiquitouness. You did use content type other than &#34;application/x-www-form-urlencoded&#34; - right ? Because sender is AJAX client, lets respond with</p>

<pre>   use JSON::XS;
   
   sub handle_store_json {
      my ($cgi) = @_;
      my $reqtype = $cgi-&#62;content_type();
      my $reqmeth = $cgi-&#62;request_method();
      if ($reqtype eq &#39;application/x-www-form-urlencoded&#39;) {die(&#34;Not valid POST content-type&#34;);}
      if ($reqmeth ne &#39;POST&#39;) {die(&#34;Only POST allowed for JSON/REST&#34;);}
      # Grab JSON from Body of HTTP Request
      my $msg = decode_json($cgi-&#62;param(&#39;POSTDATA&#39;));
      if ($msg-&#62;{&#39;type&#39;} ne &#39;store&#39;) {die(&#34;Not valid message&#34;);}
      my $h = $msg-&#62;{&#39;entry&#39;};
      my $resp = {&#39;status&#39; =&#62; &#39;OK&#39;};
      my $id = $shp-&#62;insert($h);
      if (!$id) {@$resp{&#39;status&#39;,&#39;msg&#39;} = (&#39;FAIL&#39;, &#34;Failed to Store Entry&#34;);}
      print(encode_json($resp));
      return(0);
   }</pre>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="Ways_to_use_StoredHash_in_data-pump_/_replication"
>Ways to use StoredHash in data-pump / replication</a></h1>

<pre>    my $shps = StoredHash-&#62;new(&#39;table&#39; =&#62; &#39;Products&#39;, &#39;pkey&#39; =&#62; [&#39;ProdID&#39;],
       &#39;dbh&#39; =&#62; $dbh, &#39;autoid&#39; =&#62; 1);
    my $shpt = StoredHash-&#62;new(&#39;table&#39; =&#62; &#39;Products&#39;, &#39;pkey&#39; =&#62; [&#39;ProdID&#39;],
       &#39;dbh&#39; =&#62; $dbh, &#39;autoid&#39; =&#62; 1);
    # Verify Schema sync (No strict type check, but if names match
    # it is likely no-one messed up the schema
    my $cols_s = $shps-&#62;cols();
    my $cols_t = $shpt-&#62;cols();
    # If target has superset of cols, replication would still (likely) work,
    # But this is just an example of possible validation assisted by StoredHash
    if (join(&#39;&#39;, @cols_s) ne join(&#39;&#39;, @cols_t)) {die(&#34;Schema Mismatch&#34;);}

    # Load from SOURCE ($shps)
    my $arr = $shps-&#62;loadset(); # Load ALL
    # Replicate to target ($shpt)
    map({
       if ($shpt-&#62;exists($_)) {$shpt-&#62;update($_, [$_-&#62;{&#39;ProdID&#39;}]);}
       else {$shpt-&#62;insert($_);}
    } @$arr);</pre>

<p># New API allows you to use with single persister with long lifetime by passing $dbh # at the insert / update / exists methodcall</p>

<p>#my $arr = $shps-&#62;loadset(&#39;dbh&#39; =&#62; $dbh_src); #&#39;dbh&#39; =&#62; $dbh_tgt</p>

<p>TODO: NoIDUpdate with autoid</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="StoredHash_in_a_Perl/GTKBuilder_App"
>StoredHash in a Perl/GTKBuilder App</a></h1>

<pre>    # Method for getting values
    sub onclick_save {
        my ($widget, $udata) = @_;
        my %uivals = (};
        # Use GTKBuilder / GTK widget methods to access form values
        $uivals{&#39;fullname&#39;} = $builder-&#62;get_object(&#34;fullname&#34;)-&#62;get_text();
        # ... 
        my $ok = $shp-&#62;insert(\%uivals);
        # Run dialog / Show in status
        $dialog-&#62;run();
    }</pre>

<p>#=head1 Replacing Stored Procedures with StoredHash # #Vision the following StoredProcedure stored in DB: # # INSERT INTO ... # #And its replacement using StoredHash # # my $id = $shp-&#62;insert($e); # # #Do you still want to maintain the Stored Procedure ?</p>

<h1><a class='u' href='#___top' title='click to go to top of document'
name="SEE_ALSO"
>SEE ALSO</a></h1>

<p><a href="http://search.cpan.org/perldoc?CGI" class="podlinkpod"
>CGI</a>, <a href="http://search.cpan.org/perldoc?Text%3A%3ATemplate" class="podlinkpod"
>Text::Template</a>, <a href="http://search.cpan.org/perldoc?JSON%3A%3AXS" class="podlinkpod"
>JSON::XS</a></p>

<!-- end doc -->

</body></html>
